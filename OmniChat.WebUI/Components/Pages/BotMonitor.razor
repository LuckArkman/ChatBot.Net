@page "/monitor"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation

<div class="dashboard-container">
    <div class="stats-panel">
        <div class="card">
            <h3>Mensagens Hoje</h3>
            <!-- Exemplo estático ou bindar com variável real -->
            <span class="number">@Messages.Count</span>
        </div>
        <div class="card">
            <h3>Status</h3>
            <span class="number">@(_isConnected ? "Online" : "Offline")</span>
        </div>
    </div>

    <div class="live-feed">
        <h3>Conversas em Tempo Real (Feed Global)</h3>
        <div class="chat-window">
            @foreach (var msg in Messages)
            {
                <div class="message @(msg.IsBot ? "bot" : "user")">
                    <span class="sender">@msg.SenderName (@msg.Channel)</span>
                    <p>@msg.Content</p>
                    <span class="meta">Tipo: @msg.Type | @msg.Timestamp</span>
                </div>
            }
        </div>
    </div>
</div>

<style>
    /* CSS Básico para o Monitor */
    .dashboard-container { display: grid; gap: 20px; padding: 20px; background-color: #1e1e2e; color: #fff; height: 80vh; }
    .message { padding: 10px; border-radius: 8px; margin-bottom: 10px; max-width: 80%; }
    .user { background-color: #3e4a61; align-self: flex-start; }
    .bot { background-color: #007bff; align-self: flex-end; margin-left: auto; }
    .stats-panel { display: flex; gap: 20px; margin-bottom: 20px; }
    .card { background: #2e2e42; padding: 20px; border-radius: 8px; flex: 1; }
    .card h3 { margin: 0 0 10px 0; color: #aaa; font-size: 0.9rem; }
    .number { font-size: 2rem; font-weight: bold; }
    .chat-window { background: #252535; padding: 20px; border-radius: 8px; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
    .sender { font-size: 0.8rem; color: #ccc; display: block; margin-bottom: 4px; }
    .meta { font-size: 0.7rem; color: #aaa; display: block; margin-top: 4px; text-align: right; }
</style>

@code {
    // 1. Declaração da lista para corrigir o erro 'Cannot resolve symbol Messages'
    private List<MonitorMessageViewModel> Messages = new();
    
    private HubConnection? hubConnection;
    private bool _isConnected;

    protected override async Task OnInitializedAsync()
    {
        // Configura conexão com o ChatHub (SignalR)
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        // Escuta o evento "ReceiveMessage" enviado pelo Backend
        hubConnection.On<Guid, string, string>("ReceiveMessage", (userId, message, type) =>
        {
            var isBot = type.Contains("Bot");
            
            var newMessage = new MonitorMessageViewModel
            {
                SenderName = isBot ? "OmniBot" : $"User-{userId.ToString().Substring(0, 4)}",
                Content = message,
                Channel = "Web/API", // Simplificado
                Timestamp = DateTime.Now.ToShortTimeString(),
                IsBot = isBot,
                Type = type
            };

            Messages.Add(newMessage);
            
            // Força a atualização da UI (importante em SignalR)
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        _isConnected = true;
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    // Classe ViewModel interna para dar suporte ao HTML
    public class MonitorMessageViewModel
    {
        public string SenderName { get; set; }
        public string Content { get; set; }
        public string Channel { get; set; }
        public string Timestamp { get; set; }
        public bool IsBot { get; set; }
        public string Type { get; set; }
    }
}