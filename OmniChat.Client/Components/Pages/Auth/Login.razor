@page "/login"
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using OmniChat.Client.Auth
@using OmniChat.Client.Components.Layout
@using OmniChat.Shared.DTOs
@layout MainLayout

<!-- ADICIONE ESTA LINHA AQUI -->
@rendermode InteractiveServer

@inject AuthenticationStateProvider AuthState
@inject ILocalStorageService LocalStorage
@inject NavigationManager Nav
@inject HttpClient Http

<MudGrid Justify="Justify.Center" Class="mt-16">
    <MudItem xs="12" sm="8" md="4">
        <MudCard Class="pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h4" Align="Align.Center">OmniChat</MudText>
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">Acesse sua conta</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudForm @ref="_form">
                    <MudTextField T="string" Label="Email / Telefone" @bind-Value="_loginModel.Username" Required="true" />
                    <MudTextField T="string" Label="Senha" @bind-Value="_loginModel.Password" InputType="InputType.Password" Required="true" />
                </MudForm>
                
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-2">@_errorMessage</MudAlert>
                }
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="ExecuteLogin" Disabled="_loading">
                    @if (_loading) { <MudProgressCircular Size="Size.Small" Indeterminate="true" /> }
                    else { <text>Entrar</text> }
                </MudButton>
            </MudCardActions>
            <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-4">
                Não tem uma conta? <MudLink Href="/register">Cadastre-se</MudLink>
            </MudText>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private LoginDto _loginModel = new();
    private MudForm _form;
    private bool _loading = false;
    private string _errorMessage;

    private async Task ExecuteLogin()
    {
        await _form.Validate();
        if (!_form.IsValid) return;

        _loading = true;
        _errorMessage = null;

        try 
        {
            var response = await Http.PostAsJsonAsync("https://localhost:7192/api/auth/login", _loginModel);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResultDto>();
                
                // 1. Salvar Token
                await LocalStorage.SetItemAsync("authToken", result.Token);
                
                // 2. Notificar Provider de Autenticação
                ((CustomAuthStateProvider)AuthState).MarkUserAsAuthenticated(result.Token);
                
                // 3. Redirecionar baseado no Role
                if (result.Role == "SuperAdmin") Nav.NavigateTo("/admin/plans");
                else Nav.NavigateTo("/dashboard");
            }
            else
            {
                _errorMessage = "Credenciais inválidas.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "Erro ao conectar ao servidor.";
        }
        finally
        {
            _loading = false;
        }
    }
}