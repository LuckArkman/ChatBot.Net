@page "/flows/edit/{FlowId:guid?}"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using OmniChat.Shared.DTOs
@attribute [Authorize(Roles = "OrganizationAdmin")]
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid>
        <!-- Sidebar de Propriedades -->
        <MudItem xs="4">
            <MudPaper Class="pa-4" Height="80vh">
                <MudText Typo="Typo.h6">Configuração do Nó</MudText>
                @if (_selectedNode != null)
                {
                    <MudTextField @bind-Value="_selectedNode.Content" Label="Mensagem do Bot" Variant="Variant.Outlined" Lines="3" Class="mb-4" />
                    
                    <MudSelect @bind-Value="_selectedNode.Type" Label="Tipo de Ação" T="string">
                        <MudSelectItem Value="@("Menu")">Menu de Opções</MudSelectItem>
                        <MudSelectItem Value="@("Input")">Aguardar Texto</MudSelectItem>
                        <MudSelectItem Value="@("Handover")">Transferir para Humano</MudSelectItem>
                    </MudSelect>

                    <MudText Class="mt-4">Opções (Botões)</MudText>
                    @foreach (var option in _selectedNode.Options)
                    {
                        <div class="d-flex gap-2 mb-2">
                            <MudTextField @bind-Value="option.Label" Label="Texto do Botão" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => RemoveOption(option))" />
                        </div>
                    }
                    <MudButton StartIcon="@Icons.Material.Filled.Add" OnClick="AddOption">Adicionar Opção</MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">Selecione um passo do fluxo ao lado para editar.</MudAlert>
                }
            </MudPaper>
        </MudItem>

        <!-- Visualização da Árvore -->
        <MudItem xs="8">
            <MudPaper Class="pa-4 gray-bg" Height="80vh" Style="overflow: auto;">
                <!-- CORREÇÃO: Items agora é uma lista de TreeItemData -->
                <MudTreeView T="FlowNodeDto" Items="_treeItems" MultiSelection="false">
                    <ItemTemplate>
                        <!-- O context aqui é TreeItemData<FlowNodeDto> -->
                        <MudTreeViewItem Value="@context.Value"
                                         Text="@context.Value.Content"
                                         Icon="@Icons.Material.Filled.Message"
                                         OnClick="@(() => SelectNode(context.Value))" />
                    </ItemTemplate>
                </MudTreeView>
            </MudPaper>
        </MudItem>
    </MudGrid>
    
    <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" Class="fixed-fab" OnClick="SaveFlow" />
</MudContainer>

<style>
    .fixed-fab { position: fixed; bottom: 20px; right: 20px; }
    .gray-bg { background-color: #f5f5f5; }
</style>

@code {
    [Parameter] public Guid? FlowId { get; set; }
    
    // --- CORREÇÃO 1: Mudança do tipo da coleção para TreeItemData ---
    private HashSet<TreeItemData<FlowNodeDto>> _treeItems = new(); 
    
    private FlowNodeDto? _selectedNode;

    protected override void OnInitialized()
    {
        // Mock de dados iniciais
        var rootDto = new FlowNodeDto { Id = "start", Content = "Olá! Bem vindo.", Type = "Menu" };
        rootDto.Options.Add(new FlowOptionDto { Label = "Financeiro", TargetNodeId = "fin" });

        // --- CORREÇÃO 2: Encapsulando o DTO no TreeItemData ---
        var rootItem = new TreeItemData<FlowNodeDto>
        {
            Value = rootDto,
            Text = rootDto.Content,
            Icon = Icons.Material.Filled.Message,
            // Se houver filhos hierárquicos reais, adicione-os em rootItem.Children
            Expandable = true 
        };

        _treeItems.Add(rootItem);
    }

    private void SelectNode(FlowNodeDto node) => _selectedNode = node;
    
    private void AddOption() => _selectedNode?.Options.Add(new FlowOptionDto());
    private void RemoveOption(FlowOptionDto opt) => _selectedNode?.Options.Remove(opt);

    private async Task SaveFlow()
    {
        // Ao salvar, precisamos extrair os DTOs de dentro do TreeItemData
        // var rawData = _treeItems.Select(x => x.Value).ToList();
        
        // Simulação de salvamento
        await Task.Delay(100); 
        Snackbar.Add("Fluxo salvo com sucesso!", severity: Severity.Success);
    }
}